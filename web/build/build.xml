<?xml version="1.0" encoding="UTF-8"?>
<project name="Doorlock" default="build" basedir="." description="PiDuino Lock - Electronic Deadbolt System">
  <exec command="pwd" outputProperty="current.dir"/>
  <property value="build.properties" name="build.filename" />
  <property file="${current.dir}/${build.filename}"/>
  <target name="test" description="builds package property files">
    <exec command="cat help.txt" passthru="true"/>
  </target>
  <target name="prepare" description="builds package property files">
    <if>
      <available file='${current.dir}/${build.filename}' type='file'/>
      <else>
        <exec command="cat help.txt" passthru="true"/>
        <fail>Please read help.txt and make a ${build.filename} file</fail>
      </else>
    </if>
  </target>
  <target name="build" description="Runs a clean dev build">
    <phingcall target="prepare"/>
    <phingcall target="clean"/>
    <phingcall target="update"/>
    <!-- <phingcall target="prepare" /> -->
    <!-- <phingcall target="build" /> -->
    <!-- <phingcall target="runtests" /> -->
  </target>
  <target name="update" description="rebuilds this package">
    <echo msg="${env}"/>
    <echo msg="${webserver.root}"/>
    <!-- create env target that sets env variable-->
    <echo msg="${api.url}"/>
    <!-- <delete dir="${webserver.root}" /> -->
    <copy file="./build.properties" tofile="${webserver.root}/properties/general.ini"/>
    <copy todir="${webserver.root}">
      <!-- <copy todir="${webserver.root}" overwrite="true"> -->
      <fileset dir="../src">
        <include name="**"></include>
      </fileset>
    </copy>
  </target>
  <target name="clean" description="rebuilds this package">
    <delete dir="${webserver.root}"/>
  </target>
  <target name="properties" description="builds package property files">
    <property name="config.file.location" value="../src/properties/config.ini"/>
    <delete file="${config.file.location}"/>
    <echo msg="${api.url}"/>
    <touch file="${config.file.location}"/>
    <exec command="git rev-parse --abbrev-ref HEAD" outputProperty="branch.name"/>
    <exec command="git log --pretty=format:'%h' -1" outputProperty="git.sha1"/>
    <exec command="git describe --tags" outputProperty="git.version"/>
    <append destFile="${config.file.location}" text="[config]${line.separator}"/>
    <append destFile="${config.file.location}" text="branch.name=${branch.name}${line.separator}"/>
    <append destFile="${config.file.location}" text="git.sha1=${git.sha1}${line.separator}"/>
    <append destFile="${config.file.location}" text="git.version=${git.version}${line.separator}"/>
    <append destFile="${config.file.location}" text="api.url=${api.url}${line.separator}"/>
  </target>
  <target name="runtests" description="builds package property files">
    <phpunit haltonfailure="true" printsummary="true">
      <batchtest>
        <fileset dir="../tests">
          <include name="**/**"/>
        </fileset>
      </batchtest>
    </phpunit>
  </target>

</project>
